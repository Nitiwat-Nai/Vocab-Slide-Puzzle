<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocab Slide Puzzle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Kanit:wght@300;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6c5ce7;
            --bg-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --board-current-width: 90vw; 
            --board-max-width: 400px;
            --tile-count: 3; 
            --gap: 4px;
        }

        body {
            margin: 0; padding: 0;
            background: var(--bg-grad);
            font-family: 'Fredoka', 'Kanit', sans-serif;
            height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden; color: white; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Title & Secret Bot --- */
        .app-title {
            font-size: 2rem; margin-top: 15px; margin-bottom: 5px;
            text-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 10;
            cursor: pointer; transition: transform 0.3s;
        }
        .app-title.active-bot { animation: heartbeat 1.5s infinite ease-in-out; }
        @keyframes heartbeat { 0%, 30%, 60%, 100% {transform: scale(1);} 15%, 45% {transform: scale(1.1);} }
        .bot-status {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255,0,0,0.2); padding: 5px 10px;
            border-radius: 20px; font-size: 0.7rem; display: none;
        }

        /* --- Screens --- */
        .screen {
            display: none; flex-direction: column; align-items: center;
            width: 100%; height: 100%; animation: fadeIn 0.5s ease;
            position: relative;
        }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Menu --- */
        .menu-container { display: flex; flex-direction: column; gap: 20px; margin-top: 40px; width: 80%; max-width: 300px; }
        .menu-btn {
            background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255,255,255,0.4);
            padding: 20px; border-radius: 15px; color: white; font-size: 1.2rem;
            cursor: pointer; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: space-between;
        }
        .menu-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.02); }

        /* --- Map Screen --- */
        .map-header {
            width: 90%; display: flex; align-items: center; justify-content: space-between;
            margin-top: 10px; margin-bottom: 10px; position: relative;
        }
        .btn-map-back {
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .map-title { font-size: 1.5rem; font-weight: bold; }
        
        .map-container {
            width: 100%; flex: 1; overflow-y: auto;
            padding: 20px 0; display: flex; flex-direction: column; align-items: center;
        }
        .map-path {
            display: flex; flex-direction: column; align-items: center; gap: 30px; position: relative;
            padding-bottom: 50px;
        }
        .map-line {
            position: absolute; top: 20px; bottom: 20px; left: 50%;
            width: 4px; background: rgba(255,255,255,0.3); transform: translateX(-50%); z-index: 0;
            border-radius: 2px;
        }
        .map-node {
            width: 60px; height: 60px; border-radius: 50%;
            background: white; color: var(--primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: bold; z-index: 1;
            border: 4px solid rgba(255,255,255,0.5); cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .map-node:hover { transform: scale(1.1); }
        .map-node.locked { background: #b2bec3; color: #636e72; cursor: default; }
        .map-node.active { background: #ffeaa7; color: #d63031; border-color: #fab1a0; transform: scale(1.1); box-shadow: 0 0 15px #ffeaa7; }

        /* --- Game Board --- */
        .top-bar { width: min(90vw, 400px); display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .stats-bar { width: min(90vw, 400px); background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 50px; display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.8rem; box-sizing: border-box; }
        .preview-box { width: 40px; height: 40px; background: rgba(255, 255, 255, 0.9); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 20px; border: 2px solid rgba(255,255,255,0.5); }
        
        .game-board {
            width: var(--board-current-width); height: var(--board-current-width);
            max-width: var(--board-max-width); max-height: var(--board-max-width);
            background: rgba(255, 255, 255, 0.15); border-radius: 15px; padding: 5px;
            display: grid; gap: var(--gap); grid-template-columns: repeat(var(--tile-count), 1fr);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18); position: relative; margin: 0 auto;
        }
        .tile { background: white; border-radius: 6px; cursor: pointer; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        .tile.empty { background: transparent; cursor: default; border: 2px dashed rgba(255,255,255,0.2); }
        .tile-content {
            position: absolute; font-size: calc(min(90vw, 400px) * 0.75); color: var(--primary);
            width: min(90vw, 400px); height: min(90vw, 400px); display: flex; align-items: center; justify-content: center;
            pointer-events: none; line-height: 1; transition: color 0.3s;
        }

        .controls { margin-top: 15px; display: flex; gap: 20px; }
        .btn-ctrl {
            border: none; width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
            cursor: pointer; box-shadow: 0 6px 10px rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .btn-ctrl:active { transform: scale(0.9); }
        .btn-reset { background: #fdcb6e; color: #d63031; }
        .btn-solve { background: #74b9ff; color: #0984e3; }
        .btn-back { background: #fab1a0; color: #fff; }

        /* --- Overlays --- */
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .overlay.show { opacity: 1; pointer-events: all; }
        .result-card {
            background: white; color: #333; padding: 20px; border-radius: 20px;
            text-align: center; width: 80%; max-width: 320px;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* --- Stage Summary Table --- */
        .summary-container {
            width: 100%; max-height: 50vh; overflow-y: auto;
            margin: 10px 0; border: 1px solid #eee; border-radius: 10px;
        }
        .summary-row {
            display: flex; justify-content: space-between; padding: 10px;
            border-bottom: 1px solid #f1f2f6; align-items: center;
        }
        .summary-row:last-child { border-bottom: none; }
        .s-word { font-weight: bold; color: #2d3436; }
        .s-thai { color: #636e72; font-family: 'Kanit'; }
        
        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: 50px; font-size: 1rem; cursor: pointer; margin-top: 10px;
            width: 100%; font-family: 'Fredoka', sans-serif;
        }

        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <h1 class="app-title" id="appTitle"><i class="fa-solid fa-puzzle-piece"></i> Vocab Slide</h1>
    <div id="botStatus" class="bot-status"><i class="fa-solid fa-robot"></i> AUTO</div>

    <!-- 1. MENU SCREEN -->
    <div id="screen-menu" class="screen active">
        <div style="text-align: center; margin-top: 20px; opacity: 0.8;">Select Difficulty</div>
        <div class="menu-container">
            <button class="menu-btn" onclick="openMap(3)">
                <div>
                    <div style="font-weight: bold;">Easy (3x3)</div>
                    <small>10 Stages (100 Words)</small>
                </div>
                <i class="fa-solid fa-star"></i>
            </button>
            <button class="menu-btn" onclick="openMap(4)">
                <div>
                    <div style="font-weight: bold;">Hard (4x4)</div>
                    <small>10 Stages (100 Words)</small>
                </div>
                <i class="fa-solid fa-fire"></i>
            </button>
        </div>
        <div style="margin-top: auto; margin-bottom: 20px; font-size: 0.8rem; opacity: 0.6;">Double tap title for Secret Bot</div>
    </div>

    <!-- 2. MAP SCREEN -->
    <div id="screen-map" class="screen">
        <div class="map-header">
            <!-- ปุ่มกลับหน้าหลัก (เพิ่มใหม่) -->
            <button class="btn-map-back" onclick="switchScreen('menu')">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <div class="map-title">Select Stage</div>
            <div style="width: 40px;"></div> <!-- Spacer -->
        </div>
        
        <div class="map-container">
            <div class="map-path" id="mapPath">
                <!-- Generated by JS -->
            </div>
        </div>
        
        <!-- เก็บปุ่มเดิมไว้ด้านล่างด้วยเผื่อความสะดวก -->
        <div style="padding: 10px 20px 20px 20px; width: 100%; box-sizing: border-box;">
             <button class="btn" style="background: #fab1a0;" onclick="switchScreen('menu')">Back to Menu</button>
        </div>
    </div>

    <!-- 3. GAME SCREEN -->
    <div id="screen-game" class="screen">
        <div class="top-bar">
            <div>
                <span style="opacity: 0.7; font-size: 0.8rem;">Stage <span id="uiStage">1</span> - Word <span id="uiWordIndex">1</span>/10</span>
                <div style="font-weight: bold; font-size: 0.9rem;" id="modeName">3x3 Mode</div>
            </div>
            <div class="preview-box">
                <i id="previewIcon" class="fa-solid fa-question"></i>
            </div>
        </div>

        <div class="stats-bar">
            <span><i class="fa-regular fa-clock"></i> <span id="timer">00:00</span></span>
            <span><i class="fa-solid fa-shoe-prints"></i> <span id="moveCount">0</span></span>
        </div>

        <div class="game-board" id="board"></div>

        <div class="controls">
            <button class="btn-ctrl btn-back" onclick="backToMap()" title="Back to Map"><i class="fa-solid fa-map"></i></button>
            <button class="btn-ctrl btn-reset" onclick="resetCurrentWord()" title="Reset"><i class="fa-solid fa-rotate-right"></i></button>
            <button class="btn-ctrl btn-solve" onclick="triggerSmartSolve()" title="Help"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
        </div>
    </div>

    <!-- 4. WORD CLEARED OVERLAY (Single Word) -->
    <div class="overlay" id="overlay-word">
        <div class="result-card">
            <i id="resIcon" class="fa-solid fa-star" style="font-size: 50px; color: var(--primary);"></i>
            <h2 id="resWord" style="margin: 10px 0; color: #2d3436;">WORD</h2>
            <div id="resThai" style="font-size: 1.4rem; color: #636e72; font-family: 'Kanit';">คำแปล</div>
            <div class="result-stats">Time: <span id="resTime">00:00</span></div>
            <button class="btn" onclick="nextWord()">Next Word <i class="fa-solid fa-arrow-right"></i></button>
        </div>
    </div>

    <!-- 5. STAGE COMPLETE OVERLAY (10 Words Summary) -->
    <div class="overlay" id="overlay-summary">
        <div class="result-card" style="width: 90%; max-width: 400px;">
            <h2 style="margin: 0 0 10px 0; color: var(--primary);">Stage Complete!</h2>
            <div style="font-size: 0.9rem; margin-bottom: 10px;">You learned 10 new words</div>
            
            <div class="summary-container" id="summaryList">
                <!-- List items -->
            </div>
            
            <button class="btn" onclick="finishStage()">Back to Map</button>
        </div>
    </div>

    <script>
        // --- 1. Database (Expanded for demonstration) ---
        const rawVocab = [
            {w:"Cat",t:"แมว",i:"fa-cat"}, {w:"Dog",t:"สุนัข",i:"fa-dog"}, {w:"Fish",t:"ปลา",i:"fa-fish"}, {w:"Bird",t:"นก",i:"fa-dove"},
            {w:"Car",t:"รถยนต์",i:"fa-car"}, {w:"Bus",t:"รถบัส",i:"fa-bus"}, {w:"Bike",t:"จักรยาน",i:"fa-bicycle"}, {w:"Plane",t:"เครื่องบิน",i:"fa-plane"},
            {w:"Apple",t:"แอปเปิ้ล",i:"fa-apple-whole"}, {w:"Pizza",t:"พิซซ่า",i:"fa-pizza-slice"}, {w:"Burger",t:"เบอร์เกอร์",i:"fa-burger"}, {w:"Ice Cream",t:"ไอศกรีม",i:"fa-ice-cream"},
            {w:"Home",t:"บ้าน",i:"fa-house"}, {w:"School",t:"โรงเรียน",i:"fa-school"}, {w:"City",t:"เมือง",i:"fa-city"}, {w:"Tree",t:"ต้นไม้",i:"fa-tree"},
            {w:"Sun",t:"ดวงอาทิตย์",i:"fa-sun"}, {w:"Moon",t:"ดวงจันทร์",i:"fa-moon"}, {w:"Star",t:"ดาว",i:"fa-star"}, {w:"Cloud",t:"เมฆ",i:"fa-cloud"},
            {w:"Heart",t:"หัวใจ",i:"fa-heart"}, {w:"Ghost",t:"ผี",i:"fa-ghost"}, {w:"Robot",t:"หุ่นยนต์",i:"fa-robot"}, {w:"Camera",t:"กล้อง",i:"fa-camera"},
            {w:"Book",t:"หนังสือ",i:"fa-book"}, {w:"Pen",t:"ปากกา",i:"fa-pen"}, {w:"Key",t:"กุญแจ",i:"fa-key"}, {w:"Gift",t:"ของขวัญ",i:"fa-gift"},
            {w:"Fire",t:"ไฟ",i:"fa-fire"}, {w:"Water",t:"น้ำ",i:"fa-water"}, {w:"Snow",t:"หิมะ",i:"fa-snowflake"}, {w:"Bolt",t:"สายฟ้า",i:"fa-bolt"},
            {w:"Music",t:"ดนตรี",i:"fa-music"}, {w:"Game",t:"เกม",i:"fa-gamepad"}, {w:"Lock",t:"แม่กุญแจ",i:"fa-lock"}, {w:"Bell",t:"ระฆัง",i:"fa-bell"},
            {w:"Crow",t:"อีกา",i:"fa-crow"}, {w:"Frog",t:"กบ",i:"fa-frog"}, {w:"Hippo",t:"ฮิปโป",i:"fa-hippo"}, {w:"Dragon",t:"มังกร",i:"fa-dragon"},
            {w:"Spider",t:"แมงมุม",i:"fa-spider"}, {w:"Horse",t:"ม้า",i:"fa-horse"}, {w:"Otter",t:"นาก",i:"fa-otter"}, {w:"Bug",t:"แมลง",i:"fa-bug"},
            {w:"Rocket",t:"จรวด",i:"fa-rocket"}, {w:"Train",t:"รถไฟ",i:"fa-train"}, {w:"Ship",t:"เรือ",i:"fa-ship"}, {w:"Truck",t:"รถบรรทุก",i:"fa-truck"}
        ];
        
        const stageColors = ["#e17055", "#0984e3", "#00b894", "#6c5ce7", "#fdcb6e", "#e84393", "#2d3436", "#00cec9", "#d63031", "#636e72"];

        // --- 2. State Variables ---
        let currentGridSize = 3; 
        let currentStageId = 1;
        let currentWordIndex = 0;
        
        let sessionWords = [];
        let stageWords = [];
        let solvedWordsInStage = [];

        // Game State
        let emptyPos = {r:0, c:0};
        let isSolving = false; 
        let moves = 0;
        let seconds = 0;
        let timerInterval = null;
        let moveHistory = []; 
        let isAutoPlaying = false; 

        // DOM
        const titleEl = document.getElementById('appTitle');
        const board = document.getElementById('board');
        
        // --- 3. Secret Bot ---
        let lastTap = 0;
        titleEl.addEventListener('click', (e) => handleTap());
        titleEl.addEventListener('touchend', (e) => handleTap());
        function handleTap() {
            let now = new Date().getTime();
            if(now - lastTap < 500 && now - lastTap > 0) toggleBot();
            lastTap = now;
        }
        function toggleBot() {
            isAutoPlaying = !isAutoPlaying;
            if(isAutoPlaying) {
                titleEl.classList.add('active-bot');
                document.getElementById('botStatus').style.display = 'block';
                // Trigger action if on screens
                if(document.getElementById('screen-game').classList.contains('active') && !isSolving) triggerSmartSolve();
                if(document.getElementById('screen-word').classList.contains('active')) nextWord();
                if(document.getElementById('overlay-summary').classList.contains('show')) finishStage();
            } else {
                titleEl.classList.remove('active-bot');
                document.getElementById('botStatus').style.display = 'none';
            }
        }

        // --- 4. Navigation & Map ---
        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${id}`).classList.add('active');
        }

        function openMap(size) {
            currentGridSize = size;
            document.getElementById('modeName').innerText = (size===3) ? "3x3 Mode" : "4x4 Mode";
            document.documentElement.style.setProperty('--tile-count', currentGridSize);
            
            generateSessionWords();
            renderMap();
            switchScreen('map');
        }

        function generateSessionWords() {
            let pool = [];
            while(pool.length < 100) {
                let chunk = [...rawVocab];
                chunk.sort(() => Math.random() - 0.5);
                pool = pool.concat(chunk);
            }
            pool = pool.slice(0, 100); 
            
            sessionWords = pool.map((item, idx) => {
                let stageIdx = Math.floor(idx / 10);
                return { ...item, color: stageColors[stageIdx % stageColors.length] };
            });
        }

        function renderMap() {
            const container = document.getElementById('mapPath');
            container.innerHTML = `<div class="map-line"></div>`; 
            
            for(let i=1; i<=10; i++) {
                let node = document.createElement('div');
                node.className = `map-node ${i > currentStageId ? 'locked' : ''} ${i === currentStageId ? 'active' : ''}`;
                node.innerText = i;
                if(i <= currentStageId) {
                    node.onclick = () => startStage(i);
                }
                container.appendChild(node);
            }
            
            if(isAutoPlaying) {
                setTimeout(() => {
                    if(document.getElementById('screen-map').classList.contains('active')) {
                        startStage(currentStageId);
                    }
                }, 1000);
            }
        }

        function backToMap() {
            stopTimer();
            isSolving = false; 
            switchScreen('map');
            renderMap();
        }

        // --- 5. Stage Logic ---
        function startStage(stageId) {
            currentStageId = stageId;
            currentWordIndex = 0; 
            
            let startIdx = (stageId - 1) * 10;
            stageWords = sessionWords.slice(startIdx, startIdx + 10);
            solvedWordsInStage = [];

            switchScreen('game');
            loadCurrentWord();
        }

        function loadCurrentWord() {
            stopTimer();
            isSolving = true; 

            let wordData = stageWords[currentWordIndex];
            
            document.getElementById('uiStage').innerText = currentStageId;
            document.getElementById('uiWordIndex').innerText = currentWordIndex + 1;
            document.documentElement.style.setProperty('--primary', wordData.color);
            document.getElementById('previewIcon').className = `fa-solid ${wordData.i}`;
            
            moves = 0; seconds = 0;
            document.getElementById('timer').innerText = "00:00";
            document.getElementById('moveCount').innerText = "0";

            createBoard(wordData.i);
            moveHistory = [];

            setTimeout(async () => {
                let steps = (currentGridSize === 3) ? 25 : 50;
                await performSmartShuffle(steps);
                
                startTimer();
                isSolving = false; 
                
                if(isAutoPlaying) setTimeout(triggerSmartSolve, 800);
            }, 1000);
        }

        function nextWord() {
            document.getElementById('overlay-word').classList.remove('show');
            currentWordIndex++;
            
            if(currentWordIndex >= 10) {
                showStageSummary();
            } else {
                loadCurrentWord();
            }
        }

        function resetCurrentWord() {
            if(isSolving) return;
            loadCurrentWord();
        }

        // --- 6. Board & Game Logic ---
        function createBoard(icon) {
            board.innerHTML = '';
            let count = currentGridSize * currentGridSize;
            for(let i=0; i<count; i++) {
                let r = Math.floor(i/currentGridSize);
                let c = i%currentGridSize;
                if(i === count-1) {
                    let d = document.createElement('div');
                    d.className = 'tile empty'; d.dataset.r=r; d.dataset.c=c;
                    board.appendChild(d); emptyPos = {r,c};
                } else {
                    let d = createTile(r, c, icon, i);
                    board.appendChild(d);
                }
            }
        }

        function createTile(r, c, icon, idx) {
            let d = document.createElement('div');
            d.className = 'tile'; d.dataset.r=r; d.dataset.c=c; d.dataset.orig=idx;
            d.onclick = () => { if(!isSolving) handleMove(d); };
            
            let content = document.createElement('div');
            content.className = 'tile-content';
            content.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            let origR = Math.floor(idx/currentGridSize);
            let origC = idx%currentGridSize;
            content.style.top = `${origR * -100}%`;
            content.style.left = `${origC * -100}%`;
            content.style.width = `${currentGridSize*100}%`;
            content.style.height = `${currentGridSize*100}%`;
            
            d.appendChild(content);
            return d;
        }

        function handleMove(tile) {
            let r = parseInt(tile.dataset.r);
            let c = parseInt(tile.dataset.c);
            let dr = Math.abs(r - emptyPos.r);
            let dc = Math.abs(c - emptyPos.c);
            
            if(dr + dc === 1) {
                swapTile(tile);
                moves++;
                document.getElementById('moveCount').innerText = moves;
                checkWin();
            }
        }

        function swapTile(tile) {
            let empty = document.querySelector('.tile.empty');
            moveHistory.push(tile); // Record for Bot Undo
            
            let p1 = tile.parentNode, n1 = tile.nextSibling;
            let p2 = empty.parentNode, n2 = empty.nextSibling;
            if(n1===empty) p1.insertBefore(empty, tile);
            else if(n2===tile) p1.insertBefore(tile, empty);
            else { p1.insertBefore(empty, n1); p2.insertBefore(tile, n2); }
            
            let tr=tile.dataset.r, tc=tile.dataset.c;
            tile.dataset.r = empty.dataset.r; tile.dataset.c = empty.dataset.c;
            empty.dataset.r = tr; empty.dataset.c = tc;
            emptyPos = {r:parseInt(tr), c:parseInt(tc)};
        }

        async function performSmartShuffle(steps) {
            let last = null;
            for(let i=0; i<steps; i++) {
                let neighbors = getNeighbors();
                let valid = neighbors.filter(n => n!==last);
                if(valid.length===0) valid=neighbors;
                let pick = valid[Math.floor(Math.random()*valid.length)];
                swapTile(pick); last = pick;
                await new Promise(r=>setTimeout(r, 10));
            }
        }

        function getNeighbors() {
            let arr = [];
            let {r,c} = emptyPos;
            [[r-1,c],[r+1,c],[r,c-1],[r,c+1]].forEach(([nr,nc]) => {
                if(nr>=0 && nr<currentGridSize && nc>=0 && nc<currentGridSize) {
                    let t = document.querySelector(`.tile[data-r='${nr}'][data-c='${nc}']`);
                    if(t) arr.push(t);
                }
            });
            return arr;
        }

        function checkWin() {
            let tiles = document.querySelectorAll('.tile:not(.empty)');
            let correct = 0;
            tiles.forEach(t => {
                let pos = parseInt(t.dataset.r)*currentGridSize + parseInt(t.dataset.c);
                if(pos == parseInt(t.dataset.orig)) correct++;
            });
            
            if(correct === (currentGridSize*currentGridSize)-1) {
                stopTimer();
                isSolving = true;
                setTimeout(showWordWin, 500);
            }
        }

        // --- 7. Auto Solve ---
        async function triggerSmartSolve() {
            if(isSolving) return;
            isSolving = true; stopTimer();
            
            while(moveHistory.length > 0) {
                let tile = moveHistory.pop();
                let r=parseInt(tile.dataset.r), c=parseInt(tile.dataset.c);
                let dr=Math.abs(r-emptyPos.r), dc=Math.abs(c-emptyPos.c);
                
                if(dr+dc===1) {
                    let empty = document.querySelector('.tile.empty');
                    let p1 = tile.parentNode, n1 = tile.nextSibling;
                    let p2 = empty.parentNode, n2 = empty.nextSibling;
                    if(n1===empty) p1.insertBefore(empty, tile);
                    else if(n2===tile) p1.insertBefore(tile, empty);
                    else { p1.insertBefore(empty, n1); p2.insertBefore(tile, n2); }
                    
                    let tr=tile.dataset.r, tc=tile.dataset.c;
                    tile.dataset.r = empty.dataset.r; tile.dataset.c = empty.dataset.c;
                    empty.dataset.r = tr; empty.dataset.c = tc;
                    emptyPos = {r:parseInt(tr), c:parseInt(tc)};
                    
                    if(isAutoPlaying) { moves++; document.getElementById('moveCount').innerText=moves; }
                    
                    // ปรับความเร็วบอทให้ช้าลง: 500ms ถึง 800ms
                    let delay = Math.floor(Math.random()*300) + 500;
                    await new Promise(r=>setTimeout(r, delay));
                }
            }
            setTimeout(showWordWin, 500);
        }

        // --- 8. Results & Summary ---
        function showWordWin() {
            let wd = stageWords[currentWordIndex];
            solvedWordsInStage.push(wd);
            
            document.getElementById('resWord').innerText = wd.w;
            document.getElementById('resThai').innerText = wd.t;
            document.getElementById('resIcon').className = `fa-solid ${wd.i}`;
            document.getElementById('resTime').innerText = document.getElementById('timer').innerText;
            
            if(isAutoPlaying) {
                 speak(wd.w);
                 document.getElementById('overlay-word').classList.add('show');
                 setTimeout(() => {
                     if(isAutoPlaying) nextWord();
                 }, 2000);
            } else {
                speak(wd.w);
                document.getElementById('overlay-word').classList.add('show');
            }
        }

        function showStageSummary() {
            const list = document.getElementById('summaryList');
            list.innerHTML = '';
            solvedWordsInStage.forEach(w => {
                let row = document.createElement('div');
                row.className = 'summary-row';
                row.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fa-solid ${w.i}" style="color:${w.color}; width:20px;"></i>
                        <span class="s-word">${w.w}</span>
                    </div>
                    <span class="s-thai">${w.t}</span>
                `;
                list.appendChild(row);
            });
            
            document.getElementById('overlay-summary').classList.add('show');
            
            if(isAutoPlaying) {
                setTimeout(() => {
                    if(isAutoPlaying) finishStage();
                }, 3000);
            }
        }

        function finishStage() {
            document.getElementById('overlay-summary').classList.remove('show');
            if(currentStageId < 10) currentStageId++;
            backToMap();
        }

        // --- Helpers ---
        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                seconds++;
                let m = Math.floor(seconds/60), s = seconds%60;
                document.getElementById('timer').innerText = `${pad(m)}:${pad(s)}`;
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); }
        function pad(n) { return n<10?'0'+n:n; }
        function speak(txt) {
            let u = new SpeechSynthesisUtterance(txt);
            u.lang = 'en-US';
            speechSynthesis.speak(u);
        }

    </script>
</body>
</html>
